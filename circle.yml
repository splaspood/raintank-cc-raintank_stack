machine:
  services:
    - docker
  environment:
    CHEFDK_VERSION: "0.6.2-1"
    KITCHEN_DOCKER_VERSION: "2.3.0"
dependencies:
  pre:
    - mkdir -p chefdk
    - if ! chef -v; then
        if ! [ -f chefdk/chefdk_${CHEFDK_VERSION}_amd64.deb ]; then
          wget -O chefdk/chefdk_${CHEFDK_VERSION}_amd64.deb https://opscode-omnibus-packages.s3.amazonaws.com/ubuntu/12.04/x86_64/chefdk_${CHEFDK_VERSION}_amd64.deb;
        fi;
        sudo dpkg -i chefdk/chefdk_${CHEFDK_VERSION}_amd64.deb;
      fi
    - chef gem install specific_install
    - sudo chef gem specific_install kitchen-docker -l http://github.com/peterabbott/kitchen-docker.git -b v${KITCHEN_DOCKER_VERSION}
    - mkdir ~/.chef
    - cp ~/${CIRCLE_PROJECT_REPONAME}/test/circle/knife.rb ~/.chef/knife.rb
  cache_directories:
    - ./chefdk
test:
  override:
    - chef exec berks install
    - KITCHEN_YAML=.kitchen.circleci.yml exec kitchen test
